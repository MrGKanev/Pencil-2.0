/* ===========================================================
 * trumbowyg.js v1.0
 * http://alex-d.github.com/Trumbowyg
 * ===========================================================
 * Author : Alex-D (aka Alexandre Demode)
 *          Twitter : @AlexandreDemode
 */
 $.trumbowyg={langs:{en:{viewHTML:"View HTML",formatting:"Formatting",p:"Paragraph",blockquote:"Quote",code:"Code",header:"Header",bold:"Bold",italic:"Italic",strikethrough:"Stroke",underline:"Underline",strong:"Strong",em:"Emphasis",unorderedList:"Unordered list",orderedList:"Ordered list",insertImage:"Insert Image...",insertVideo:"Insert Video...",link:"Link",createLink:"Insert link...",unlink:"Remove link",justifyLeft:"Align Left",justifyCenter:"Align Center",justifyRight:"Align Right",justifyFull:"Align Justify",horizontalRule:"Insert horizontal rule",fullscreen:"fullscreen",close:"Close",submit:"Confirm",reset:"Cancel",urlInvalid:"Invalid URL"}},btnsGrps:{design:["bold","italic","underline","strikethrough"],semantic:["strong","em"],justify:["justifyLeft","justifyCenter","justifyRight","justifyFull"],lists:["unorderedList","orderedList"]}};(function(c){c.fn.trumbowyg=function(g,k){if(c.isObject(g)||g==null){return this.each(function(){var e=c(this);if(!e.data("trumbowyg")){e.data("trumbowyg",new b(this,g))}})}else{if(this.length==1){try{var j=c(this).data("trumbowyg");switch(g){case"openModal":return j.openModal(k.title,k.content);case"closeModal":return j.closeModal();case"openModalInsert":return j.buildInsert(g.title,g.fields,g.callback);case"saveSelection":return j.saveSelection();case"getSelection":return j.selection;case"getSelectedText":return j.selection+"";case"restoreSelection":return j.restoreSelection();case"destroy":return j.destroy();case"lang":return j.lang;case"duration":return j.o.duration}}catch(i){}}}return false};var b=function(e,g){this.$e=c(e);this.$creator=c(e);if(typeof g==="undefined"||typeof g.lang==="undefined"||typeof c.trumbowyg.langs[g.lang]==="undefined"){this.lang=c.trumbowyg.langs.en}else{this.lang=c.extend(true,{},c.trumbowyg.langs.en,c.trumbowyg.langs[g.lang])}this.o=c.extend(true,{lang:"en",dir:"ltr",duration:200,mobile:false,tablet:true,closable:false,fullscreenable:true,fixedBtnPane:false,fixedFullWidth:false,semantic:false,resetCss:false,autogrow:false,prefix:"trumbowyg-",convertLink:true,btns:["viewHTML","|","formatting","|",c.trumbowyg.btnsGrps.design,"|","link","|","insertImage","|",c.trumbowyg.btnsGrps.justify,"|",c.trumbowyg.btnsGrps.lists,"|","horizontalRule"],btnsAdd:[],btnsDef:{viewHTML:{func:"toggle"},formatting:{dropdown:{defaultFunc:"formatBlock",p:{},blockquote:{},/*h1:{title:this.lang.header+" 1"},*/h2:{title:this.lang.header+" 2"},h3:{title:this.lang.header+" 3"},h4:{title:this.lang.header+" 4"}}},p:{func:"formatBlock"},blockquote:{func:"formatBlock"},h1:{func:"formatBlock",title:this.lang.header+" 1"},h2:{func:"formatBlock",title:this.lang.header+" 2"},h3:{func:"formatBlock",title:this.lang.header+" 3"},h4:{func:"formatBlock",title:this.lang.header+" 4"},bold:{},italic:{},underline:{},strikethrough:{},strong:{func:"bold"},em:{func:"italic"},link:{dropdown:{createLink:{},unlink:{}}},insertImage:{},justifyLeft:{},justifyCenter:{},justifyRight:{},justifyFull:{},unorderedList:{func:"insertUnorderedList"},orderedList:{func:"insertOrderedList"},horizontalRule:{func:"insertHorizontalRule"}}},g);if(this.o.semantic&&!g.btns){this.o.btns=["viewHTML","|","formatting","|",c.trumbowyg.btnsGrps.semantic,"|","link","|","insertImage","|",c.trumbowyg.btnsGrps.justify,"|",c.trumbowyg.btnsGrps.lists,"|","horizontalRule"]}else{if(g&&g.btns){this.o.btns=g.btns}}this.init()};b.prototype={init:function(){this.height=this.$e.css("height");if(this.isEnabled()){this.buildEditor(true);return}this.buildEditor();this.buildBtnPane();this.fixedBtnPaneEvents();this.buildOverlay()},buildEditor:function(g){if(g===true){if(!this.$e.is("textarea")){var e=this.buildTextarea().val(this.$e.val());this.$e.hide().after(e)}return}this.$box=c("<div/>",{"class":this.o.prefix+"box "+this.o.prefix+this.o.lang+" trumbowyg"});this.isTextarea=true;if(this.$e.is("textarea")){this.$editor=c("<div/>")}else{this.$editor=this.$e;this.$e=this.buildTextarea().val(this.$e.val());this.isTextarea=false}this.$e.hide().addClass(this.o.prefix+"textarea");var i="";if(this.isTextarea){i=this.$e.val();this.$box.insertAfter(this.$e).append(this.$editor).append(this.$e)}else{i=this.$editor.html();this.$box.insertAfter(this.$editor).append(this.$e).append(this.$editor);this.syncCode()}this.$editor.addClass(this.o.prefix+"editor").attr("contenteditable",true).attr("dir",this.o.dir).html(i);if(this.o.resetCss){this.$editor.addClass(this.o.prefix+"reset-css")}if(!this.o.autogrow){this.$editor.css({height:this.height,overflow:"auto"});this.$e.css({height:this.height,overflow:"auto"})}var j=this;this.$editor.on("dblclick","img",function(){var k=c(this);j.buildInsert(j.lang.insertImage,{url:{label:"URL",value:k.attr("src")},alt:{label:"Alt",name:"alt",value:k.attr("alt")}},function(l){k.attr("src",l.url);k.attr("alt",l.alt)});return false});this.$editor.on("mousedown",function(){j.sementicCode()});this.$editor.on("blur",function(){j.syncCode()})},buildTextarea:function(){return c('<textarea name="'+this.$e.attr("id")+'"></textarea>',{height:this.height})},buildBtnPane:function(){if(this.o.btns===false){return}var g=this.o.prefix;this.$btnPane=c("<ul/>",{"class":g+"button-pane"});c.each(this.o.btns.concat(this.o.btnsAdd),c.proxy(function(l,k){try{var j=k.split("btnGrp-");if(j[1]!=undefined){k=c.trumbowyg.btnsGrps[j[1]]}}catch(m){}if(!c.isArray(k)){k=[k]}c.each(k,c.proxy(function(p,o){try{var n=c("<li/>");if(o=="|"){n.addClass(g+"separator")}else{if(o=="viewHTML"){n.addClass(g+"not-disable")}n.append(this.buildBtn(o))}this.$btnPane.append(n)}catch(q){}},this))},this));var e=c("<li/>",{"class":g+"not-disable "+g+"buttons-right"});if(this.o.fullscreenable){e.append(this.buildRightBtn("fullscreen").on("click",c.proxy(function(j){var i=g+"fullscreen";this.$box.toggleClass(i);if(this.$box.hasClass(i)){c("body").css("overflow","hidden");this.$box.css({position:"fixed",top:0,left:0,width:"100%",height:"100%",margin:0,padding:0,zIndex:10});c([this.$editor,this.$e]).each(function(){c(this).css({height:"100%",overflow:"auto"})});this.$btnPane.css("width","100%")}else{c("body").css("overflow","auto");this.$box.removeAttr("style");if(!this.o.autogrow){h=this.height;c([this.$editor,this.$e]).each(function(){c(this).css("height",h)})}}c(window).trigger("scroll")},this)))}if(this.o.closable){e.append(this.buildRightBtn("close").on("click",c.proxy(function(j){var i=g+"fullscreen";if(this.$box.hasClass(i)){c("body").css("overflow","auto")}this.destroy()},this)))}if(e.not(":empty")){this.$btnPane.append(e)}this.$box.prepend(this.$btnPane)},buildBtn:function(g){var l=this.o.btnsDef[g];var j=this;var i=c("<a/>",{href:"javascript:void(null);","class":this.o.prefix+g+"-button",text:l.text||l.title||this.lang[g]||g,title:l.title||l.text||this.lang[g]||g,mousedown:function(n){if(!l.dropdown||j.$box.find("."+g+"-"+j.o.prefix+"dropdown").is(":hidden")){c("body").trigger("mousedown")}if(j.$btnPane.hasClass(j.o.prefix+"disable")&&!c(this).parent().hasClass(j.o.prefix+"not-disable")){return false}j.execCommand((l.dropdown?"dropdown":"")||l.func||g,l.param||g);n.stopPropagation();n.preventDefault();return false}});if(l.dropdown){i.addClass(this.o.prefix+"open-dropdown");var e=this.o.prefix+"dropdown "+this.o.prefix+"fixed-top";var m=c("<div/>",{"class":g+"-"+e+" "+e});m.data("visible",false);for(var k in l.dropdown){if(c.isObject(l.dropdown[k])){m.append(this.buildSubBtn(l.dropdown,k))}}this.$box.append(m.hide())}return i},buildSubBtn:function(i,e){c("body").trigger("mousedown");var g=i[e];return c("<a/>",{href:"javascript:void(null);",text:g.text||g.title||this.lang[e]||e,title:g.title||g.text||this.lang[e]||e,mousedown:c.proxy(function(j){c("body").trigger("mousedown");this.execCommand(i.defaultFunc||g.func||e,g.param||e);j.stopPropagation();j.preventDefault();return false},this)})},buildRightBtn:function(e){return c("<a/>",{href:"javascript:void(null);","class":this.o.prefix+e+"-button",title:this.lang[e],text:this.lang[e]})},buildOverlay:function(){return this.$overlay=c("<div/>",{"class":this.o.prefix+"overlay"}).css({top:this.$btnPane.css("height"),height:this.$editor.outerHeight()}).appendTo(this.$box)},showOverlay:function(){c(window).trigger("scroll");this.$overlay.fadeIn(200)},hideOverlay:function(){this.$overlay.fadeOut(200)},fixedBtnPaneEvents:function(){if(!this.o.fixedBtnPane){return}this.isFixed=false;c(window).on("scroll",c.proxy(function(j){if(!this.$box){return}this.syncCode();var i=c(window).scrollTop();var k=this.$box.offset().top+2;var g=(i-k>0)&&((i-k-parseInt(this.height.replace("px","")))<0);if(g){if(!this.isFixed){this.isFixed=true;this.$btnPane.css({position:"fixed",top:0,left:(this.o.fixedFullWidth)?"0":"auto",width:(this.o.fixedFullWidth)?"100%":this.$box.css("width"),zIndex:7});this.$editor.css({marginTop:this.$btnPane.css("height")});this.$e.css({marginTop:this.$btnPane.css("height")})}c("."+this.o.prefix+"fixed-top",this.$box).css({position:this.o.fixedFullWidth?"fixed":"absolute",top:this.o.fixedFullWidth?this.$btnPane.css("height"):parseInt(this.$btnPane.css("height").replace("px",""))+(i-k)+"px",zIndex:15})}else{if(this.isFixed){this.isFixed=false;this.$btnPane.css({position:"relative"});this.$editor.css({marginTop:0});this.$e.css({marginTop:0});c("."+this.o.prefix+"fixed-top",this.$box).css({position:"absolute",top:this.$btnPane.css("height")})}}},this))},destroy:function(){var e=this.getCode();if(this.isTextarea){this.$box.after(this.$e.css({height:this.height}).val(e).removeClass(this.o.prefix+"textarea").show())}else{this.$box.after(this.$editor.css({height:this.height}).removeClass(this.o.prefix+"editor").attr("contenteditable",false).html(e).show())}this.$box.remove();this.$creator.removeData("trumbowyg")},toggle:function(){this.sementicCode();this.$editor.toggle();this.$e.toggle();this.$btnPane.toggleClass(this.o.prefix+"disable");this.$btnPane.find("."+this.o.prefix+"viewHTML-button").toggleClass(this.o.prefix+"active")},dropdown:function(e){var i=this.$box.find("."+e+"-"+this.o.prefix+"dropdown");var g=this.$btnPane.find("."+this.o.prefix+e+"-button");if(i.is(":hidden")){g.addClass(this.o.prefix+"active");i.css({position:"absolute",top:this.$btnPane.css("height"),left:(this.o.fixedFullWidth&&this.isFixed)?g.offset().left+"px":(g.offset().left-this.$btnPane.offset().left)+"px"}).show();c(window).trigger("scroll");c("body").on("mousedown",c.proxy(function(j){c("."+this.o.prefix+"dropdown").hide();c("."+this.o.prefix+"active").removeClass(this.o.prefix+"active");c("body").off("mousedown")},this))}else{c("body").trigger("mousedown")}},getCode:function(){return this.$e.val()},setCode:function(e){this.$e.val(e)},syncCode:function(){if(this.$editor.is(":visible")){this.$e.val(this.$editor.html())}else{this.$editor.html(this.$e.val())}if(this.o.autogrow){this.height=this.$editor.css("height");this.$e.css({height:this.height})}},sementicCode:function(){this.syncCode();if(this.o.semantic){this.sementicTag("b","strong");this.sementicTag("i","em");this.$e.val(this.$editor.html())}},sementicTag:function(e,g){c(e,this.$editor).each(function(){c(this).replaceWith(function(){return"<"+g+">"+c(this).html()+"</"+g+">"})})},createLink:function(){this.saveSelection();this.buildInsert(this.lang.createLink,{url:{label:"URL",value:"http://"},title:{label:"Title",value:this.selection},text:{label:"Text",value:this.selection}},"createLink")},formatBlock:function(e){if(c.browser.msie){e="<"+e+">"}document.execCommand("formatBlock",false,e);this.syncCode()},insertImage:function(){this.saveSelection();this.buildInsert(this.lang.insertImage,{url:{label:"URL",value:"http://"},alt:{label:"Alt",value:this.selection}},"insertImage")},execCommand:function(g,j){if(g!="dropdown"){this.$editor.focus()}try{this[g](j)}catch(i){try{g(j)}catch(i){this.$editor.focus();if(g=="insertHorizontalRule"){j=null}document.execCommand(g,false,j)}}this.syncCode()},openModal:function(k,i){var j=this.o.prefix;if(c("."+j+"modal-box",this.$box).size()>0){return false}this.saveSelection();this.showOverlay();this.$btnPane.addClass(j+"disable");c("."+j+"not-disable",this.$btnPane).not("."+j+"buttons-right").removeClass(j+"not-disable").addClass(j+"not-disable-old");var g=c("<div/>",{"class":j+"modal "+j+"fixed-top"}).css({top:this.$btnPane.css("height")}).appendTo(this.$box);$e=this.$editor;$form=c("<form/>",{action:"javascript:void(null);",html:i}).on("submit",function(l){g.trigger(j+"confirm");l.preventDefault()}).on("reset",function(l){g.trigger(j+"cancel");l.preventDefault()});var e=c("<div/>",{"class":j+"modal-box",html:$form}).css("top","-"+g.css("height")).appendTo(g).animate({top:0},this.o.duration);c("<span/>",{text:k,"class":j+"modal-title"}).prependTo(e);e.find("input:first").focus();this.buildModalBtn("reset",e);this.buildModalBtn("submit",e);c("body").trigger("scroll");return g},buildModalBtn:function(e,g){return c("<input/>",{"class":this.o.prefix+"modal-button "+this.o.prefix+"modal-"+e,value:this.lang[e]||e,type:e}).appendTo(g.find("form"))},closeModal:function(){this.$btnPane.removeClass(this.o.prefix+"disable");c("."+this.o.prefix+"not-disable-old",this.$btnPane).removeClass(this.o.prefix+"not-disable-old").addClass(this.o.prefix+"not-disable");that=this;$modalBox=c("."+this.o.prefix+"modal-box",this.$box);$modalBox.animate({top:"-"+$modalBox.css("height")},this.o.duration,function(){c(this).parent().remove();that.hideOverlay()})},buildInsert:function(l,e,j){var g="";for(f in e){if(e[f].label==undefined){e[f].label=f.charAt(0).toUpperCase()+f.slice(1)}if(e[f].name==undefined){e[f].name=f}f=e[f];g+="<label>"+f.label+' : <input type="text" name="'+f.name+'" value="'+(f.value||"")+'"></label>'}var k=this.openModal(l,g);var i=this;k.on(this.o.prefix+"confirm",function(){var n=c(this).find("form");var m={};for(f in e){m[f]=c('input[name="'+f+'"]',n).val()}if(m.url!=null&&m.url!=undefined){if(m.url!="http://"){i.restoreSelection();if(c.isString(j)){document.execCommand(j,false,m.url)}else{j(m)}i.syncCode();i.closeModal();k.off(i.o.prefix+"confirm")}else{n.find(".error").remove();n.append('<span class="error">'+i.lang.urlInvalid+"</span>")}}});k.one(this.o.prefix+"cancel",function(){k.off(i.o.prefix+"confirm");i.closeModal();i.restoreSelection()})},saveSelection:function(){this.selection=null;if(window.getSelection){var e=window.getSelection();if(e.getRangeAt&&e.rangeCount){this.selection=e.getRangeAt(0)}}else{if(document.selection&&document.selection.createRange){this.selection=document.selection.createRange()}}},restoreSelection:function(){range=this.selection;if(range){if(window.getSelection){var e=window.getSelection();e.removeAllRanges();e.addRange(range)}else{if(document.selection&&range.select){range.select()}}}},isEnabled:function(){var e="iPhone|iPod|Android|BlackBerry|WindowssPhone|ZuneWP7";var i=new RegExp("(iPad|webOS)");var g=new RegExp("("+e+")");return(this.o.tablet===true&&i.test(navigator.userAgent))||(this.o.mobile===true&&g.test(navigator.userAgent))}};var d=Object.prototype.toString,a=Object.prototype.hasOwnProperty;c.isObject=function(g){if(d.call(g)!=="[object Object]"){return false}var e;for(e in g){}return !e||a.call(g,e)};c.isString=function(e){return typeof(e)==="string"}})(jQuery);